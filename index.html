<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vite + TS</title>
</head>

<body>
  <div id="app">
    <table>
      <tbody>
        <tr>
          <td>Origin</td>
          <td><audio name="origin" src="./deps/World/test/vaiueo2d.wav" controls=""></audio></td>
        </tr>
        <tr>
          <td>Sync</td>
          <td><audio name="sync"></audio></td>
        </tr>
        <tr>
          <td>Async</td>
          <td><audio name="async"></td>
        </tr>
        <tr>
          <td>AsyncTask</td>
          <td><audio name="async-task"></td>
        </tr>
      </tbody>
    </table>
    <div name="info" style="margin-top: 10px"></div>
  </div>
  <script>
    import("./src/main.ts").then(async (WORLD) => {
      const wav = await (await fetch(document.querySelector('audio[name=origin]').src)).arrayBuffer()
      const setAudio = (name, wav) => {
        const audio = document.querySelector(`audio[name=${name}]`)
        audio.controls = !0
        URL.revokeObjectURL(audio.src)
        audio.src = URL.createObjectURL(wav)
      }
      WORLD.create().then(world => {
        const [x, fs] = world.wavread(wav)
        const [_f0, t] = world.dio(x, fs)
        const f0 = world.stonemask(x, _f0, t, fs)
        const sp = world.cheaptrick(x, f0, t, fs)
        const ap = world.d4c(x, f0, t, fs)
        const y = world.synthesis(f0.map(v => v * 2 ** (6 / 12)), sp, ap, fs)
        const wavy = world.wavwrite(y, fs)
        setAudio('sync', wavy)
      })
      WORLD.createAsync().then(async (world) => {
        const [x, fs] = await world.wavread(wav)
        const [_f0, t] = await world.dio(x, fs)
        const f0 = await world.stonemask(x, _f0, t, fs)
        const sp = await world.cheaptrick(x, f0, t, fs)
        const ap = await world.d4c(x, f0, t, fs)
        const y = await world.synthesis(f0.map(v => v * 2 ** (12 / 12)), sp, ap, fs)
        const wavy = await world.wavwrite(y, fs)
        setAudio('async', wavy)
      })
      WORLD.createAsync().then(async (world) => {
        let wavy = await world.fetch(({ world }, [wav]) => {
          let [x, fs] = world.wavread(wav)
          let [_f0, t] = world.dio(x, fs)
          let f0 = world.stonemask(x, _f0, t, fs)
          let sp = world.cheaptrick(x, f0, t, fs)
          let ap = world.d4c(x, f0, t, fs)
          let y = world.synthesis(f0.map(v => v * 2 ** (18 / 12)), sp, ap, fs)
          return [world.wavwrite(y, fs)]
        }, [wav])
        setAudio('async-task', wavy)
      })
      const world = await WORLD.create()
      const worldAsync = await WORLD.createAsync()
      let _ = { WORLD, world, worldAsync }
      document.querySelector('[name=info]').innerText = world.about()
      try {
        world.wavread(new ArrayBuffer(0))
      } catch (error) {
        _.error = error
      }
      Object.assign(window, _)
      console.log(_)
    })
  </script>
</body>

</html>